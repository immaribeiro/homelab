# VM type
vmType: "vz"
vmOpts:
  vz:
    rosetta:
      enabled: false

# CPU and Memory
cpus: 2
memory: "4GiB"
disk: "20GiB"

# Image
images:
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
    arch: "aarch64"

# Network - CRITICAL for K3s
networks:
  - lima: shared
    macAddress: "52:55:55:00:00:01"
    interface: "lima0"

# Mounts
mounts:
  - location: "~"
    writable: false

# SSH
ssh:
  localPort: 0
  loadDotSSHPubKeys: true
  forwardAgent: false

# Provisioning (combined)
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      
      # Create ubuntu user if it doesn't exist
      if ! id -u ubuntu &>/dev/null; then
        useradd -m -s /bin/bash -G sudo ubuntu
        echo "ubuntu:ubuntu" | chpasswd
      fi
      
      # Configure static IP on eth0
      cat <<EOF > /etc/netplan/51-static-eth0.yaml
      network:
        version: 2
        renderer: networkd
        ethernets:
          eth0:
            addresses:
              - 192.168.5.10/24
            routes:
              - to: default
                via: 192.168.5.2
            nameservers:
              addresses:
                - 8.8.8.8
                - 8.8.4.4
      EOF
      chmod 600 /etc/netplan/51-static-eth0.yaml
      netplan apply
      
      # Wait for network to stabilize
      sleep 3
      
      # Update system
      apt-get update
      apt-get install -y curl vim net-tools
      
      # Disable swap (required for K8s)
      swapoff -a
      sed -i '/swap/d' /etc/fstab
      
      # Enable IP forwarding
      cat <<EOF > /etc/sysctl.d/k8s.conf
      net.ipv4.ip_forward = 1
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      EOF
      sysctl --system
      
      # Set hostname
      hostnamectl set-hostname k3s-control-1

  - mode: system
    script: |
      #!/bin/bash
      modprobe br_netfilter
      modprobe overlay
      cat <<EOF > /etc/modules-load.d/k8s.conf
      br_netfilter
      overlay
      EOF

containerd:
  system: false
  user: false
