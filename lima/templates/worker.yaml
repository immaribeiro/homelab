# VM type
vmType: "vz"
rosetta:
  enabled: false
  binfmt: false

# CPU and Memory
cpus: 2
memory: "3GiB"
disk: "15GiB"

# Image
images:
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
    arch: "aarch64"

# Network - CRITICAL for K3s
# NOTE: Change macAddress for each worker
networks:
  - lima: shared
    macAddress: "52:55:55:00:00:02"
    interface: "lima0"

# Mounts
mounts:
  - location: "~"
    writable: false
  - location: "/tmp/lima"
    writable: true

# SSH
ssh:
  localPort: 0
  loadDotSSHPubKeys: true
  forwardAgent: false

# Provisioning (combined)
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      
      # Update system
      apt-get update
      apt-get install -y curl vim net-tools
      
      # Disable swap
      swapoff -a
      sed -i '/swap/d' /etc/fstab
      
      # Enable IP forwarding
      cat <<EOF > /etc/sysctl.d/k8s.conf
      net.ipv4.ip_forward = 1
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      EOF
      sysctl --system
      
      # Set hostname (will be overridden by script)
      hostnamectl set-hostname k3s-worker-1

  - mode: system
    script: |
      #!/bin/bash
      modprobe br_netfilter
      modprobe overlay
      cat <<EOF > /etc/modules-load.d/k8s.conf
      br_netfilter
      overlay
      EOF

containerd:
  system: false
  user: false
